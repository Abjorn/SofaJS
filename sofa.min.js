// SofaJS CouchDB JavaScript Library
// Version 0.1 Copyright Corey Schram <corey@coreymedia.com> 2011
// Last Modified 5/25/2011
// Distributed under the MIT License
(function(g){function f(){if(!d.configuration._configured)throw"SofaJS is not configured.";}function e(a){var b;b=g.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");a.method=a.method||"GET";a.url=a.url;b.open(a.method,a.url,!0);a.contentType?b.setRequestHeader("Content-Type",a.contentType):b.setRequestHeader("Content-Type","application/json");b.onreadystatechange=function(){var c=!1;if(b.readyState===4){if(b.responseText.slice(0,1)==="{"||b.responseText.slice(0,1)==="[")c=
!0;if(b.status>=200&&b.status<300)c?a.success(JSON.parse(b.responseText)):a.success(b.responseText);else if(a.error)c?a.error(b.status,JSON.parse(b.responseText)):a.error(b.status,b.responseText);else throw"Uncaught AJAX Error ("+b.status+"): "+b.responseText;}};a.data?(console.log(JSON.stringify(a.data)),b.send(JSON.stringify(a.data))):b.send();return b}function h(a){var b="?",c;for(c in a)if(a.hasOwnProperty(c))switch(b.slice(-1)!=="?"&&(b+="&"),b+=c+"=",typeof a[c]){case "number":b+=a[c];break;
case "string":b+='"'+a[c]+'"';break;case "boolean":b+=a[c]?"true":"false";break;default:b+=JSON.stringify(a[c])}return b}var d={configuration:{}};d.config=function(a){if(!a.server)throw"SofaJS server must be set.";a.server.slice(-1)!=="/"&&(a.server+="/");d.configuration=a;d.configuration._configured=!0};d.status=function(a,b){f();e({method:"GET",url:d.configuration.server,success:a,error:b})};d.uuids=function(a,b,c){f();e({method:"GET",url:a<2?d.configuration.server+"_uuids":d.configuration.server+
"_uuids?count="+a,success:function(a){b(a.uuids)},error:c})};d.replicate=function(a){f();e({method:"POST",url:d.configuration.server+"_replicate",data:{source:a.source,target:a.target},success:a.success,error:a.error})};d.DB=function(a){f();if(!a)throw"Sofa.DB constructor expects a database name argument.";this.db=d.configuration.server+a;this.db.slice(-1)!=="/"&&(this.db+="/")};d.DB.prototype.create=function(a,b){e({method:"PUT",url:this.db,success:a,error:b})};d.DB.prototype.del=function(a,b){e({method:"DELETE",
url:this.db,success:a,error:b})};d.DB.prototype.all=function(a,b){e({method:"GET",url:this.db+"_all_docs",success:function(b){a(b.rows)},error:b})};d.DB.prototype.get=function(a,b,c){e({method:"GET",url:this.db+a,success:b,error:c})};d.DB.prototype.save=function(a,b,c){a._id?e({method:"PUT",url:this.db+a._id,data:a,success:b,error:c}):e({method:"POST",url:this.db,data:a,success:function(c){a._id=c.id;a._rev=c.rev;b(c)},error:c})};d.DB.prototype.view=function(a){var b=this.db+"_design/"+a.doc+"/_view/"+
a.view;a.params&&(b+=h(a.params));e({method:"GET",url:b,success:function(b){a.success(b.rows,b)},error:a.error})};d.DB.prototype.show=function(a){var b=this.db+"_design/"+a.doc+"/_show/"+a.show;a.id&&(b+="/"+a.id);a.params&&(b+=h(a.params));e({method:"GET",url:b,success:a.success,error:a.error})};g.Sofa=d})(this);